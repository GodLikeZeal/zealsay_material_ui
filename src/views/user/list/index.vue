<template>
    <div class="con">
        <v-layout
                row
                wrap
        >
            <v-flex
                    xs12
                    sm6
                    md3
            >
                <v-text-field
                        label="Solo"
                        v-model="searchData.name"
                        placeholder="姓名"
                        solo
                ></v-text-field>
            </v-flex>
            <v-flex
                    xs12
                    sm6
                    md3
            >
                <v-text-field
                        label="Solo"
                        v-model="searchData.phoneNumber"
                        placeholder="手机号码"
                        solo
                ></v-text-field>
            </v-flex>
            <v-flex
                    xs12
                    sm6
                    md3
            >
                <v-text-field
                        label="Solo"
                        v-model="searchData.email"
                        placeholder="邮箱"
                        solo
                ></v-text-field>
            </v-flex>
            <v-flex
                    xs6
                    sm2
                    md1
            >
                <v-btn color="info" @click="search(searchData)">搜索 <br/>
                    <v-icon small>search</v-icon>
                </v-btn>
            </v-flex>
            <v-flex
                    xs6
                    sm2
                    md1
            >
                <v-btn color="success" title="解封" @click="handleUnsealingSelected(selected)"> 解封 <br/>
                    <v-icon small>how_to_reg</v-icon>
                </v-btn>
            </v-flex>
            <v-flex
                    xs6
                    sm2
                    md1
            >
                <v-btn color="error" title="禁用" @click="handleDisabledSelected(selected)"> 封禁 <br/>
                    <v-icon small>fa-ban</v-icon>
                </v-btn>
            </v-flex>

        </v-layout>
        <v-data-table
                v-model="selected"
                :headers="headers"
                :pagination.sync="pagination"
                :items="desserts"
                :loading="loading"
                hide-actions
                select-all
                class="elevation-1"
        >
            <template v-slot:headers="props">
                <tr>
                    <th>
                        <v-checkbox
                                :input-value="props.all"
                                :indeterminate="props.indeterminate"
                                primary
                                hide-details
                                @click.stop="toggleAll"
                        ></v-checkbox>
                    </th>
                    <th
                            v-for="header in props.headers"
                            :key="header.text"
                            :class="['column sortable', pagination.descending ? 'desc' : 'asc', header.value === pagination.sortBy ? 'active' : '']"
                            @click="changeSort(header.value)"
                    >
                        <v-icon small>arrow_upward</v-icon>
                        {{ header.text }}
                    </th>
                </tr>
            </template>
            <template
                    slot="items"
                    slot-scope="props"
            >
                <tr :active="props.selected">
                    <td @click="props.selected = !props.selected">
                        <v-checkbox
                                :input-value="props.selected"
                                primary
                                hide-details
                        ></v-checkbox>
                    </td>
                    <td class="text-xs-right">
                        <v-avatar
                                size="32px"
                                color="grey lighten-4"
                        >
                            <v-img :lazy-src="props.item.avatar" :src="props.item.avatar" alt="avatar"></v-img>
                        </v-avatar>
                    </td>
                    <td class="text-xs-right">{{ props.item.username }}</td>
                    <td class="text-xs-right">{{ props.item.name }}</td>
                    <td class="text-xs-right" v-if="props.item.sex==1"><img width="24px"
                                                                            src="../../../assets/sex/boy.png"/></td>
                    <td class="text-xs-right" v-if="props.item.sex==0"><img width="24px"
                                                                            src="../../../assets/sex/girl.png"/></td>
                    <td class="text-xs-right">{{ props.item.age }}</td>
                    <td class="text-xs-right">{{ props.item.phoneNumber }}</td>
                    <td class="text-xs-right">{{ props.item.email }}</td>
                    <td class="text-xs-right text-success" v-if="props.item.status == 'NORMAL'">正常
                        <v-icon color="success" small>fa-plug</v-icon>
                    </td>
                    <td class="text-xs-right text-error" v-if="props.item.status == 'DISABLED'">封禁
                        <v-icon color="error" small>fa-ban</v-icon>
                    </td>
                    <td class="text-xs-right text-warning" v-if="props.item.status == 'LOCK'">锁定
                        <v-icon color="warning" small>fa-lock</v-icon>
                    </td>
                    <td class="text-xs-right">
                        <v-layout
                                justify-center
                                class="mb-2"
                        >
                            <v-btn icon flat color="primary" title="详情" @click="handleInfo(props.item)">
                                <v-icon>portrait</v-icon>
                            </v-btn>
                            <v-btn icon flat color="primary" title="编辑" @click="handleEdit(props.item)">
                                <v-icon>create</v-icon>
                            </v-btn>
                            <v-btn icon flat color="primary" title="解封" @click="handleUnsealing(props.item)">
                                <v-icon>how_to_reg</v-icon>
                            </v-btn>
                            <v-btn icon flat color="primary" title="封禁" @click="handleDisabled(props.item)">
                                <v-icon>remove_circle</v-icon>
                            </v-btn>
                        </v-layout>
                    </td>
                </tr>
            </template>
        </v-data-table>
        <div class="right pagination">
            <Pagination :pagination="pagination"></Pagination>
        </div>
        <div>
            <forms :row="row" :alert="formVisible" @handleCancel='handleCancel'></forms>
        </div>
    </div>
</template>
<script>
    import {getUserList, disabeledUser, disabeledUserBatch, unsealingUserBatch, unsealingUser} from "@/api/user";
    import forms from './components/form'
    import info from './components/info'
    import Pagination from "../../../components/table/Pagination";

    export default {
        name: 'User',
        components: {Pagination, forms, info},
        data() {
            return {
                searchData: {},
                selected: [],
                loading: true,
                headers: [
                    {
                        text: '头像',
                        value: 'avatar'
                    },
                    {
                        text: '用户名',
                        value: 'username'
                    },
                    {text: '姓名', value: 'name'},
                    {text: '性别', value: 'sex'},
                    {text: '年龄', value: 'age'},
                    {text: '手机号', value: 'phoneNumber'},
                    {text: '邮箱', value: 'email'},
                    {text: '状态', value: 'status'},
                    {text: '操作', value: ''}
                ],
                desserts: [],
                pagination: {
                    descending: true,
                    page: 1,
                    rowsPerPage: 10, // -1 for All
                    sortBy: '',
                    totalItems: 2
                },
                row: {},
                dialogVisible: false,
                formVisible: false,
                title: ''
            };
        },
        created() {
            getUserList().then(res => {
                this.desserts = res.data.records;
                this.pagination.page = res.data.currentPage;
                this.pagination.rowsPerPage = res.data.pageSize;
                this.pagination.totalItems = res.data.total;
                this.loading = false;
            });
        },
        methods: {
            search(obj) {
                getUserList(obj).then(res => {
                    this.desserts = res.data.records;
                    this.pagination.page = res.data.currentPage;
                    this.pagination.rowsPerPage = res.data.pageSize;
                    this.pagination.totalItems = res.data.total;
                });
            },
            toggleAll() {
                if (this.selected.length) this.selected = [];
                else this.selected = this.desserts.slice()
            },
            changeSort(column) {
                if (this.pagination.sortBy === column) {
                    this.pagination.descending = !this.pagination.descending
                } else {
                    this.pagination.sortBy = column;
                    this.pagination.descending = false
                }
            },
            handleEdit(row) {
                this.formVisible = true;
                this.row = {...row};
                // let editDialog = this.$dialog.show(forms, {
                //     row: row,
                //     width: 600
                // });
            },
            handleCancel() {
                this.formVisible = false;
            },
            handleInfo(row) {
                this.$dialog.show(info, {row: row, width: 600})
            },
            handleDisabled(row) {
                this.$swal({
                    title: '确定要封禁吗？',
                    text: '一旦封禁，该用户无法登录系统',
                    type: 'warning',
                    showCancelButton: true
                }).then((result) => {
                    if (result.value) {
                        disabeledUser(row.id).then(res => {
                            if (res.code === '200' && res.data) {
                                this.$swal({
                                    title: '操作成功!',
                                    text: '该用户已经被封禁',
                                    type: 'success'
                                });
                                this.search('');
                            } else {
                                this.$swal({
                                    title: '操作失败!',
                                    text: res.message,
                                    type: 'error'
                                });
                            }
                        });
                    }
                });
            },
            handleUnsealing(row) {
                this.$swal({
                    title: '确定要解封吗？',
                    text: '将该用户从封禁状态改成正常状态，该用户可正常使用系统',
                    type: 'warning',
                    showCancelButton: true
                }).then((result) => {
                    if (result.value) {
                        unsealingUser(row.id).then(res => {
                            if (res.code === '200' && res.data) {
                                this.$swal({
                                    title: '操作成功!',
                                    text: '该用户已经成功解封',
                                    type: 'success'
                                });
                                this.search('');
                            } else {
                                this.$swal({
                                    title: '操作失败!',
                                    text: res.message,
                                    type: 'error'
                                });
                            }
                        });
                    }
                });
            },
            handleDisabledSelected(selected) {
                let param = selected.map(s => s.id);
                if (param.length > 0) {
                    this.$swal({
                        title: '确定要封禁吗？',
                        text: '一旦封禁，所选用户无法登录系统',
                        type: 'warning',
                        showCancelButton: true
                    }).then((result) => {
                        if (result.value) {
                            disabeledUserBatch(param).then(res => {
                                if (res.code === '200' && res.data) {
                                    this.$swal({
                                        title: '操作成功!',
                                        text: '所选用户已经被封禁',
                                        type: 'success'
                                    });
                                    this.search('');
                                } else {
                                    this.$swal({
                                        title: '操作失败!',
                                        text: res.message,
                                        type: 'error'
                                    });
                                }
                            });
                        }
                    });
                } else {
                    this.$swal({
                        title: '无法封禁！',
                        text: '请至少选择一条需要封禁的用户！',
                        type: 'warning'
                    });
                }
            },
            handleUnsealingSelected(selected) {
                let param = selected.map(s => s.id);
                if (param.length > 0) {
                    this.$swal({
                        title: '确定要解封吗？',
                        text: '将所选用户从封禁状态改成正常状态，该用户可正常使用系统',
                        type: 'warning',
                        showCancelButton: true
                    }).then((result) => {
                        if (result.value) {
                            unsealingUserBatch(param).then(res => {
                                if (res.code === '200' && res.data) {
                                    this.$swal({
                                        title: '操作成功!',
                                        text: '所选用户已经成功解封',
                                        type: 'success'
                                    });
                                    this.search('');
                                } else {
                                    this.$swal({
                                        title: '操作失败!',
                                        text: res.message,
                                        type: 'error'
                                    });
                                }
                            });
                        }
                    });
                } else {
                    this.$swal({
                        title: '无法封禁！',
                        text: '请至少选择一条需要解封的用户！',
                        type: 'warning'
                    });
                }
            }
        }
    };
</script>
<style lang="less" scoped>
    .con {
        padding: 0 20px;
    }

    .layout > .flex {
        padding: 8px;
    }

    .v-icon {
        color: #2196f3;
        cursor: pointer;
    }

    .img {
        width: 30px;
        height: 30px;
    }

    .v-image__image {
        width: 30px;
        height: 30px;
    }

    .text-success {
        color: forestgreen;
        font-weight: bold;
        padding: 0 12px !important;
    }

    .text-error {
        color: #dc6752;
        font-weight: bold;
        padding: 0 12px !important;
    }

    .text-warning {
        color: #dca173;
        font-weight: bold;
        padding: 0 12px !important;
    }

    .pagination {
        margin: 20px;
    }

</style>

